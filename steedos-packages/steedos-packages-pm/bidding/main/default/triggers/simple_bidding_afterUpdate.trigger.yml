name: simple_bidding_afterUpdate
listenTo: simple_bidding
when:
  - afterUpdate
isEnabled: true
handler: >-
  const { doc, previousDoc } = ctx.params


  // 发起审批时，将立项状态修正为“立项审批”

  if (doc.instance_state === 'pending' && doc.instance_state !==
  previousDoc.instance_state) {
      const status = await ctx.broker.call('@steedos-labs/bidding.getBiddingStatusByCode', { 'code': 'LX001' });
      await ctx.broker.call('objectql.update',
          { 'objectName': 'simple_bidding', 'id': doc._id, 'doc': { 'bidding_status': status } }
      )
  }


  // 审批通过后，将立项状态修正为“标书制作”

  if (doc.instance_state === 'approved' && doc.instance_state !==
  previousDoc.instance_state) {
      const status = await ctx.broker.call('@steedos-labs/bidding.getBiddingStatusByCode', { 'code': 'LX003' });
      await ctx.broker.call('objectql.update',
          { 'objectName': 'simple_bidding', 'id': doc._id, 'doc': { 'bidding_status': status } }
      )
  }
