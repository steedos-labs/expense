name: cost_business_loan_reimburse_business_loan_reimburse_afterUpdate
listenTo: cost_business_loan_reimburse
when:
  - afterUpdate
  - afterInsert
isEnabled: true
handler: >-
  // _ : lodash

  // moment: moment

  // validator: validator

  // ctx

  // objects

  // services

  // const { doc, previousDoc, userId, spaceId } = ctx.params

  // console.log("doc", doc)

  // //审批状态为已审核

  // if (doc.instance_state === 'approved' && doc.instance_state !==
  previousDoc.instance_state) {

  //     //查询子表借款核销费用报销明细

  //     const res = await ctx.broker.call('objectql.find', {

  //         objectName: 'cost_loan_detail',

  //         query: {

  //             fields: ['_id', 'cost_code'],

  //             filters: ['daily_expense', '=', doc._id],

  //         },

  //     }

  //     );

  //     //根据id查关联借款单

  //     const loanDoc = await
  ctx.getObject('cost_personal_loan').findOne(doc.personal_loan);

  //     //借款核销金额=借款金额修改借款状态为'已还款'

  //     if (doc.loan_paid_amount == loanDoc.amount) {

  //         const modifyBusinessDoc = await
  ctx.broker.call('objectql.directUpdate',

  //             {

  //                 objectName: 'cost_personal_loan',

  //                 doc: {

  //                     state: '已还款'

  //                 },

  //                 id: loanDoc._id

  //             },

  //         );

  //         console.log("modifyBusinessDoc", modifyBusinessDoc)

  //     }

  //     for (var ress of res) {

  //         //带出我的费用

  //         const mydoc = await ctx.broker.call('objectql.find', {

  //             objectName: 'cost_reimburse_detail',

  //             query: {

  //                 fields: ['_id', 'status'],

  //                 filters: ['_id', '=', ress.cost_code],

  //             },

  //         }

  //         );

  //         for (var mydocs of mydoc) {

  //             //修改我的费用报销状态

  //             const modifyStateDoc = await ctx.broker.call(

  //                 'objectql.directUpdate',

  //                 {

  //                     objectName: 'cost_reimburse_detail',

  //                     doc: {

  //                         status: 'complete'

  //                     },

  //                     id: mydocs._id

  //                 },

  //             );

  //         }

  //     }


  // }
